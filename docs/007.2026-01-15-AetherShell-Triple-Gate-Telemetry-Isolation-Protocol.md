### **[LOG-007] ARCHITECTURAL SPECIFICATION: MULTI-GATE TELEMETRY HUB**

**STATUS:** OPERATIONAL / SESSION `eb4a7679` ACTIVE  
**PROTOCOL:** ASYNC VECTOR-TO-PIXEL BRIDGE

---

#### **I. NETWORK TOPOLOGY & PORT ISOLATION**

To prevent protocol interference between legacy 16-bit hardware (DSi) and modern high-level consumers (iOS/Python), the system implements a **Triple-Gate Routing** strategy. Java acts as the central state-machine, multiplexing three distinct traffic lanes into a unified memory context.

| **Gate**           | **Port** | **Encapsulation**     | **Reasoning**                                                                                                                                                                                                              |
| :----------------- | :------- | :-------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Ingress-Alpha**  | `8080`   | HTTP (ngrok-tunneled) | **DSi Hardware Interface.** Legacy TCP/IP stack on DSi cannot negotiate modern TLS handshakes. Port 8080 is reserved for unencrypted raw coordinate POSTing to minimize DSi CPU overhead.                                  |
| **Ingress-Beta**   | `8443`   | HTTPS (Cloudflare)    | **Mobile Command Layer.** iOS requires ATS (App Transport Security). 8443 maps to 8080 internally, providing the iPhone a secure tunnel to poll session status without exposing the legacy DSi endpoint to the public web. |
| **Internal-Gamma** | `5001`   | TCP (Localhost)       | **Compute/Inference Layer.** Python Worker logic is decoupled on its own port to prevent blocking the Java Main Thread during heavy image processing or LLM token generation.                                              |

---

#### **II. DATA EXCHANGE LOGIC (THE HANDSHAKE)**

The communication flow is designed as a "Producer-Consumer" loop where Java remains the single source of truth (`SessionObject`).

1.  **Coordinate Hydration:** The DSi pushes semicolon-delimited ASCII strings to `/session/data/{id}` via Gate 8080. Java appends these to a `CopyOnWriteArrayList` to prevent `ConcurrentModificationException` during simultaneous reads.
2.  **State Triggering:** Upon DSi signal `(X)` or iPhone Request, Java initiates a **Callback Trigger** to Python on `localhost:5001`.
3.  **Cross-Port Retrieval:** Python acts as a temporary client. It requests the full JSON array from `8080`, processes the vector math, and writes the resulting `.gif` or `.png` to a persistent static directory on the filesystem.
4.  **Metadata Update:** Python sends a "Processing Complete" signal back to Java. Java updates the `SessionStatus` flag in memory.

---

#### **III. PERSISTENCE STRATEGY: MEMORY VS. DISK**

The architecture avoids a traditional SQL database at this stage to eliminate I/O latency during real-time drawing.

- **Transient Data (RAM):** The raw coordinate strings live in Javaâ€™s `ConcurrentHashMap`. This allows for sub-millisecond response times when Python requests the "PO Box" contents.
- **Static Asset Offloading:** Instead of Java "carrying" the generated image in memory, the file is offloaded to a `/static/output/` directory.
- **Static Resource Mapping:** Java is configured to serve this directory. The iPhone is handed a **Deterministic URL** (`/output/eb4a7679.gif`). This ensures the iPhone fetches the heavy asset directly from the disk-stream, bypassing the Java application logic entirely for the final render.

---

#### **IV. FAILURE MODE MITIGATION**

- **Polling Collision:** Because the iPhone (8443) and DSi (8080) target different endpoint paths (`/status` vs `/data`), they never compete for the same resource.
- **Buffer Overflow:** Java limits the frame count per session to prevent Python from timing out during the render loop.
- **Latency Masking:** The iPhone polls the `/status` endpoint. Java returns the current `PointCount` and `State` (DRAWING/PROCESSING). This provides the user with visual feedback on the iPhone even while the DSi is still transmitting.

---

**NEXT LOG ENTRY:** `[LOG-008]` Deployment of the Python Flask Listener on `5001` for Automated Render Triggering.
