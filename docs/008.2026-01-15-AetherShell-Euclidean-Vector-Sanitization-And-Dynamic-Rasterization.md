# AetherShell Developer Log 008

## Project AetherShell: Advanced Render Logic & Coordinate Telemetry Sanitization

**Version:** 1.4  
**Date:** 2026-01-15  
**Subject:** Implementation of Euclidean Distance Thresholding and Pen-Lift Sentinel Handling

## 1. Executive Summary

Log 008 details the critical refinement of the **Python Triple-Gate Worker (Port 5001)**. After transitioning to vectorized path streaming in Log 006, a secondary "Geometric Noise" issue was identified: the Nintendo DS digitizer emits junk coordinates during the physical lift-off of the stylus, creating diagonal streaks to the corner (0,0). This log documents the implementation of **Euclidean Distance Thresholding** and **Coordinate Sanitization** to ensure high-fidelity PNG reconstruction for Gemini AI analysis.

---

## 2. The "Teleportation" Phenomenon

### A. The Digitizer Release Glitch

- **Phenomenon:** When the user lifts the stylus, the resistive touch screen briefly registers a "floating" coordinate—often (0,0) or the extreme edge of the ADC range—before the `KEY_TOUCH` interrupt fires.
- **Legacy Failure:** The standard `draw.line(points)` method treats the entire coordinate list as a continuous path. This results in "Projections," where every intentional stroke is visually connected to the top-left origin.

### B. Geometric Solution: Euclidean Filtering

- **Method:** Instead of drawing a single poly-line, the renderer now treats the path as a series of independent segments (Pn, Pn+1).
- **Logic:** For every segment, the system calculates the pixel distance using the Pythagorean theorem:
  d = sqrt((x2 - x1)^2 + (y2 - y1)^2)
- **Threshold:** A strict **30-pixel limit** (unscaled) was established. If d > 30, the system identifies a "Pen-Up Event" and suppresses the draw command for that segment, effectively "lifting the virtual pen."

---

## 3. The Refined Rendering Pipeline

### A. Coordinate Sanitization & Upscaling

To support high-resolution AI interpretation, the renderer performs a **Scale-8 Transform**.

- **Input:** 256 x 192 (NDS Native)
- **Output:** 2048 x 1536 (High-Definition PNG)
- **Sanitization:** Explicit filtering of `(x <= 1, y <= 1)` prevents the "Home-to-Origin" streak, even if the distance threshold is bypassed.

### B. Segment-by-Segment Rasterization

The drawing engine was refactored from a bulk processor to a **Validated Segment Iterator**:

1. **Parser:** Splits the raw semicolon-delimited string from the Java Hub.
2. **Validator:** Checks for `ValueError` and `NoneType` to prevent Python worker crashes during malformed transmission.
3. **Stroke Engine:** Uses `PIL.ImageDraw` with a `joint="curve"` parameter to simulate natural ink flow, maintaining a proportional brush width (8px) to match the upscaled resolution.

---

## 4. Implementation Logic (Python Worker)

```python
# Core Segment Validation Logic
for j in range(len(points) - 1):
    p1 = points[j]
    p2 = points[j+1]

    # Calculate distance to detect "Digitizer Jumps"
    dist = math.sqrt((p2[0] - p1[0])**2 + (p2[1] - p1[1])**2)

    # Only rasterize if movement is within physiological human limits
    if dist < (30 * scale):
        draw.line([p1, p2], fill="black", width=scale, joint="curve")
```

## 5. Dynamic Session Management

### A. Variable Frame-Depth Handling

- The renderer was upgraded from a static 3-frame limit to a Dynamic List Iterator.
- **Mechanism:** Utilizing `enumerate(frames)`, the Python worker now generates an arbitrary number of PNGs based on the Java Hub's POST payload.
- **Naming Convention:** Filenames are strictly bound to the `session_id` (e.g., `{session_id}_frame_{i}.png`), ensuring thread-safety when multiple NDS clients are streaming to the Hub simultaneously.

### B. Automated Directory Synchronization

- **Integration:** The `OUTPUT_DIR` is programmatically mapped to the Spring Boot `static/output` resource path.
- **Persistence:** Implementation of `os.makedirs(exist_ok=True)` ensures that the filesystem is prepared for I/O operations without manual server-side configuration.

## 6. Technical Summary Table

| Logic Component      | Technical Implementation            | Benefit                                  |
| -------------------- | ----------------------------------- | ---------------------------------------- |
| Artifact Suppression | Euclidean Distance Check (`d < 30`) | Fixed: Removed diagonal "ghost" lines    |
| Origin Filtering     | `if x <= 1 and y <= 1: continue`    | Fixed: Eliminated corner-anchor dots     |
| Visual Fidelity      | Scale-8 Upscaling (2048 × 1536)     | Enhanced: Optimal Gemini AI recognition  |
| Memory Safety        | Try–Except Coordinate Parsing       | Stable: Worker no longer crashes on junk |
