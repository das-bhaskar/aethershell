# AetherShell Developer Log 012

## Project AetherShell: Spatial AR Integration & Gesture-Based Manipulation

**Version:** 1.8  
**Date:** 2026-01-16  
**Subject:** Bridging 2D Animation into 3D Space with Plane Detection and Spatial Fallbacks

---

## 1. Executive Summary

Log 012 details the migration of the AetherShell client from a 2D SwiftUI view to a fully realized Augmented Reality (AR) environment. The primary objective was to project NDS-rendered animations into the user's physical space. Key accomplishments include the implementation of a dual-strategy placement engine (Plane Detection vs. Fixed-Distance Fallback), 3D coordinate correction for the iPhone 12 mini, and the introduction of raycasted drag gestures for real-time object manipulation.

---

## 2. The Spatial Challenge

Moving from a 2D "White Screen" to AR introduced several high-order technical hurdles:

1.  **The Orientation Mismatch:** By default, SceneKit and ARKit treat different axes as "Up." Initial deployments resulted in the animation being rotated 90° clockwise (lying on its side).
2.  **Depth Perception:** A 2D plane in a 3D world is infinitely thin, making it invisible when viewed from the side.
3.  **Environmental Lighting/Tracking:** In low-light or featureless environments, ARKit fails to find a horizontal plane, leaving the user with an empty camera feed.
4.  **Device Ergonomics:** On the smaller iPhone 12 mini screen, standard 20cm objects appeared too small and distant for meaningful interaction.

---

## 3. Technical Implementation Details

### A. Dual-Strategy Placement (The Fallback Engine)

To ensure the app "just works" regardless of room conditions, I implemented a timer-based fallback mechanism within the `ARContainer` Coordinator.

- **Strategy 1 (Plane Detection):**  
  The app monitors `didAdd node` delegates for `ARPlaneAnchor`. If a table is found within 3 seconds, the object is anchored to the real-world surface.

- **Strategy 2 (Spatial Fallback):**  
  If the timer expires before a plane is detected, the app performs a transform calculation to "force-drop" the object 50cm in front of the camera's current POV.

---

### B. The 3D Math of Rotation and Depth

To solve the "sideways" and "paper-thin" issues, I transitioned the geometry from a `SCNPlane` to an `SCNBox` and applied Euler angle corrections.

- **Euler Correction:**  
  To stand the object upright after it defaulted to a right-hand tilt, a `π/2` radian shift was applied to the Z-axis.

- **Dimensionality:**  
  Utilized a box with a depth of `0.01m` (1cm) to provide a physical "lip," allowing the user to walk around the object without it disappearing.

---

### C. Raycasted Interaction Logic

Implemented `UIPanGestureRecognizer` combined with ARKit Raycasting to allow users to move the house.

```swift
if let query = sceneView.raycastQuery(
    from: location,
    allowing: .estimatedPlane,
    alignment: .any
) {
    let results = sceneView.session.raycast(query)
    if let firstResult = results.first {
        node.simdWorldTransform = firstResult.worldTransform
    }
}
```

---

## 4. Technical Performance Table

| Feature         | Implementation Strategy                 | Result                                            |
| --------------- | --------------------------------------- | ------------------------------------------------- |
| Tracking Engine | ARKit `ARWorldTrackingConfiguration`    | 6-DOF tracking of the NDS sketch                  |
| Fallback Timer  | 3.0s `DispatchQueue` delay              | Guaranteed visibility in dark/plain rooms         |
| Object Scaling  | 0.4m (40cm) `SCNBox`                    | Optimal visibility for iPhone 12 mini form factor |
| Input Mapping   | `UIPanGesture` + Raycasting             | Intuitive "Pick up and Move" user experience      |
| Animation Sync  | 10Hz `Timer` on `firstMaterial.diffuse` | Flicker-free 3D flipbook effect                   |

---

## 5. Key Technical Decisions

- **Transition to SCNBox**  
  Chosen over `SCNPlane` to give the "NDS Card" physical weight. Even at 1cm thickness, the shadow and side-profile significantly improve the feeling of presence.

- **Z-Axis Rotation Correction**  
  Used a `π/2` radian shift on the Z-axis to counteract the default coordinate system of the iPhone's portrait camera orientation.

- **Estimated Plane Raycasting**  
  Allowed the object to be dragged even in areas where a perfect plane was not detected, using ARKit's best-guess understanding of the environment to maintain interactivity.

---

## 6. Summary

Log 012 marks the completion of the "Aether" in AetherShell. The project has evolved from a simple data relay into a spatial computing application. The NDS is no longer just sending coordinates; it is projecting a living, animated entity into the user's home.

The iPhone 12 mini–specific optimizations ensure the experience is accessible and tactile.

**Next Phase:**  
RealityKit integration for improved physics and lighting.
