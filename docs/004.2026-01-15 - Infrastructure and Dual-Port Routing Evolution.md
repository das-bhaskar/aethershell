# AetherShell Developer Log 004

## Project AetherShell: Infrastructure & Routing Evolution

**Version:** 1.2  
**Date:** 2026-01-15  
**Subject:** Transition from Header-Based Routing to Dual-Port Infrastructure

## 1. Executive Summary

Log 04 documents a pivot in the system's communication architecture. To ensure maximum stability for legacy hardware (Nintendo DS) while maintaining modern security standards for mobile clients (iPhone), the project has transitioned from software-level "User-Agent" routing to a dual-port infrastructure-based ingress model.

---

## 2. Architectural Pivot: The "Two-Door" System

### A. Deprecation of Header-Based Routing

- **Previous Plan:** Use a single port (8080) and a Java-based "Router" to distinguish between devices via `User-Agent` strings.
- **Decision:** Terminated [TASK 1.3.2] as "Not Planned."
- **Reasoning:** Header-based switching adds unnecessary complexity to every controller method. Furthermore, the Nintendo DS has limited resources to manage complex headers, and spoofing headers for testing creates additional development friction.

### B. Implementation of Multi-Connector Ingress

- **New Decision:** Utilize a **Monolithic Spring Boot Hub** with two distinct Tomcat connectors listening on different ports.
- **Reasoning:** This allows the backend to know the device type implicitly based on the port of entry, effectively separating the "Legacy Lane" from the "Modern Lane" at the network level rather than the application level.

---

## 3. Revised Port Configuration Matrix

| Device          | Ingress Tunnel | Internal Port | Protocol        | Data Format            |
| :-------------- | :------------- | :------------ | :-------------- | :--------------------- |
| **Nintendo DS** | **ngrok**      | `8080`        | HTTP (Insecure) | Raw Text / Simple JSON |
| **iPhone**      | **Cloudflare** | `8443`        | HTTPS (Secure)  | Structured JSON / HTML |

---

## 4. Technical Benefits of the Dual-Port Monolith

1. **Security Isolation:** SSL termination happens at Cloudflare for the `8443` port. We can apply strict JWT/OAuth security filters to the modern port without breaking the DSâ€™s inability to handle secure handshakes on `8080`.
2. **Simplified Controllers:** Controllers can now use `request.getServerPort()` or simply reside on different mapping paths assigned to specific connectors, removing `if/else` logic from the business layer.
3. **Data Consistency:** Both ports feed into the same Spring Boot instance, ensuring that the **PostgreSQL** database remains the single source of truth for AI-generated narrative states across all devices.

---

## 5. Next Steps (Post-Break)

- **[TASK 1.3.4]:** Implement the `WebserverConfiguration` bean to open the secondary `8443` connector.
- **[TASK 1.2.1-REVISED]:** Update Cloudflare Tunnel configuration to point to the new dedicated modern ingress port (8443).

---

_End of Specification_
